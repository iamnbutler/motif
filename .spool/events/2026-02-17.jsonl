{"v":1,"op":"reopen","id":"mln635v3-7dyl","ts":"2026-02-17T20:15:51.008782Z","by":"@iamnbutler","branch":"main","d":{}}
{"v":1,"op":"update","id":"mln635v3-7dyl","ts":"2026-02-17T20:15:51.042489Z","by":"@iamnbutler","branch":"main","d":{"description":"When rendering multiple quads via instancing, only some instances appear. \n\nROOT CAUSE FOUND: Metal's float3 has 16-byte alignment, but Rust's [f32; 3] has 4-byte alignment. This caused:\n- Rust QuadInstance: 112 bytes\n- Metal QuadInstance: 128 bytes (due to float3 padding alignment)\n- 16 byte mismatch per instance, causing Metal to read wrong offsets\n\nFIX: Changed Metal shader from 'float3 _padding' to three separate 'float _pad1, _pad2, _pad3' fields. Individual floats have 4-byte alignment matching Rust."}}
{"v":1,"op":"complete","id":"mln635v3-7dyl","ts":"2026-02-17T20:15:55.711583Z","by":"@iamnbutler","branch":"main","d":{"resolution":"done"}}
{"v":1,"op":"create","id":"mlr1o70k-xovp","ts":"2026-02-17T20:17:14.372916Z","by":"@iamnbutler","branch":"main","d":{"description":"Write documentation explaining the Metal float3 alignment issue we encountered with instanced rendering.\n\n## Background\nWhen implementing GPU instancing for quad rendering, only some quads rendered despite correct data on the Rust side.\n\n## Root Cause\nMetal Shading Language has different alignment rules than Rust's #[repr(C)]:\n\n| Type | Size | Rust Alignment | Metal Alignment |\n|------|------|----------------|-----------------|\n| float | 4 | 4 | 4 |\n| float2 | 8 | 4 | 8 |\n| float3 | 12 | 4 | **16** |\n| float4 | 16 | 4 | 16 |\n\nThe key insight: float3 in Metal has 16-byte alignment (not 12\\!), while Rust's [f32; 3] has only 4-byte alignment.\n\nThis caused our QuadInstance struct to be:\n- Rust: 112 bytes\n- Metal: 128 bytes (extra padding before float3 field)\n\nWhen copying N instances, Metal read each instance at offset N*128, but data was at offset N*112, causing progressive drift.\n\n## Solution\nReplace `float3 _padding` with three separate `float` fields, which have 4-byte alignment in both languages.\n\n## Prevention\nWhen defining GPU structs shared between Rust and Metal:\n1. Avoid float3 in Metal (use float4 or separate floats)\n2. Add compile-time size assertions\n3. Consider using crates like bytemuck with explicit size checks\n\n## References\n- Apple Metal Shading Language Spec: Data Types section\n- Commit: 43e46ef","priority":"p3","stream":"mliupru8-vi36","tags":["docs"],"title":"Document Metal struct alignment gotcha"}}
